<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title></title>
<script type="text/javascript" src="../js/canvaschart-0.0.1.js">
</script>
<script type="text/javascript" src="../js/magicCube.js">
</script>
<script type="text/javascript">
var startTime = null;
var endTime = null;
var ready = false;
var running = false;
function drawSideBackground(central, singleSide, cxt, color) {
    var bgLength = 3 * singleSide + 1.5 * singleSide;

    var leftBG = central.buildPolygon(bgLength, Math.PI / 2, Math.PI + Math.PI / 6);
    var downBG = central.buildPolygon(bgLength, -Math.PI / 6, Math.PI / 2);
    var rightBG = central.buildPolygon(bgLength, Math.PI + Math.PI / 6, -Math.PI / 6);

    cxt.fillStyle = color;
    leftBG.draw(cxt);
    downBG.draw(cxt);
    rightBG.draw(cxt);
}

function show() {
    var c = document.getElementById("mg");
    c.height = 500;
    c.width = 500;
    c.style.border = "1px solid";

    var bgColor = "#000000";
    var sideColor = "#eeeeee";
    var cxt = c.getContext("2d");
    cxt.fillStyle = bgColor;
    cxt.fillRect(0, 0, c.width, c.height);

    var singleSide = 40;
    var central = new CPoint(c.width / 2, c.height / 2);

    drawSideBackground(central, singleSide, cxt, sideColor);

    magicCube = new MagicCube();
    magicCube.drawSides(cxt, central, singleSide);
}

function redrawSides() {
    var c = document.getElementById("mg");
    var cxt = c.getContext("2d");
    var singleSide = 40;
    var central = new CPoint(c.width / 2, c.height / 2);

    magicCube.drawSides(cxt, central, singleSide);
}

function reset() {
    magicCube = new MagicCube();
    redrawSides();
    taskCanceled();
}
function clickEvent() {
    c.cursor.style = "pointer";
}
function showCursor(event) {
    c = document.getElementById("mg");
    cxt = c.getContext("2d");
    var singleSide = 40;
    var central = new CPoint(c.width / 2, c.height / 2);
    var clickable = false;
    for (var i = 0; i < magicCube.cubes.length; i++) {
        for (var j = 0; j < magicCube.cubes[i].visibleSides.length; j++) {
            var side = magicCube.cubes[i].visibleSides[j];
            var x = event.clientX - c.offsetLeft;
            var y = event.clientY - c.offsetTop;
            side.draw(cxt, central, singleSide, magicCube.cubes[i]);
            if(cxt.isPointInPath(x, y)){
                clickable = true;
                log(x, y);
                side.draw(cxt, central, singleSide, magicCube.cubes[i], true);
            }
        }
    }
    if (clickable) {
        c.style.cursor = "pointer";
    }
    else {
        c.style.cursor = "default";
    }
}

function moveStep(event) {
    c = document.getElementById("mg");
    cxt = c.getContext("2d");
    var central = new CPoint(c.width / 2, c.height / 2);
    var singleSide = 40;
    for (var i = 0; i < magicCube.cubes.length; i++) {
        for (var j = 0; j < magicCube.cubes[i].visibleSides.length; j++) {
            var side = magicCube.cubes[i].visibleSides[j];
            side.draw(cxt, central, singleSide, magicCube.cubes[i]);
            var x = event.clientX - c.offsetLeft;
            var y = event.clientY - c.offsetTop;
            if (cxt.isPointInPath(x, y)) {
                doRotate(side, magicCube.cubes[i], event);
            }
        }
    }
}
function doRotate(side, cube, event) {
    if (ready == true) {
        if (running == false) {
            taskStart();
        }
    }

    if (side instanceof XSide) {
        if (cube.y == 1) {
            magicCube.rotateZ(cube.z, 'anti');
        }
        else if (cube.y == -1) {
            magicCube.rotateZ(cube.z);
        }
        else {
            if (cube.z == 1) {
                magicCube.rotateY(0);
            }
            else if (cube.z == -1) {
                magicCube.rotateY(0, 'anti');
            }
        }
    }
    else if (side instanceof YSide) {
        if (cube.z == 1) {
            magicCube.rotateX(cube.x, 'anti');
        }
        else if (cube.z == -1) {
            magicCube.rotateX(cube.x);
        }
        else {
            if (cube.x == 1) {
                magicCube.rotateZ(0);
            }
            else if (cube.x == -1) {
                magicCube.rotateZ(0, 'anti');
            }
        }
    }
    else if (side instanceof ZSide) {
        if (cube.x == 1) {
            magicCube.rotateY(cube.y, 'anti');
        }
        else if (cube.x == -1) {
            magicCube.rotateY(cube.y);
        }
        else {
            if (cube.y == 1) {
                magicCube.rotateX(0);
            }
            else if (cube.y == -1) {
                magicCube.rotateX(0, 'anti');
            }
        }
    }
    redrawSides();
    showCursor(event);
    if (running && magicCube.allRestored()) {
        taskFinished();
    }
}
function randomSteps(steps) {
    for (var i = 0; i < steps; i++) {
        var side = Math.floor(Math.random() * 3);
        var value = Math.floor(Math.random() * 3);
        var direction;
        if (Math.floor(Math.random() * 2) == 1) {
            direction = 'anti';
        }
        if (side == 0) {
            magicCube.rotateX(value - 1, direction);
        }
        else if (side == 1) {
            magicCube.rotateY(value - 1, direction);
        }
        else {
            magicCube.rotateZ(value - 1, direction);
        }

    }
    redrawSides();
}
function startNewTask() {
    resetStates();
    randomSteps(1);
    ready = true;
    document.getElementById("msg").innerHTML = "Will start timer at your first click"
}

function taskStart() {
    startClock();
    document.getElementById("grade").innerHTML = "Time spent: " + 0 + " seconds";
}
function taskFinished() {
    stopClock();
    ready = false;
    document.getElementById("msg").innerHTML = "Congratulations!"
    var timeSpent = Math.round((endTime - startTime) / 100)/10;
    document.getElementById("grade").innerHTML = "Your grade is: " + timeSpent + " seconds";
}
function taskCanceled() {
    stopClock();
    resetStates();
}
function resetStates(){
    document.getElementById("msg").innerHTML = "Not started yet";
    document.getElementById("grade").innerHTML = "";
    ready = false;
    running = false;
}
function startClock() {
    running = true;
    startTime = new Date().getTime();
}
function stopClock() {
    running = false;
    endTime = new Date().getTime();
}
</script>
</head>
<body onload="show();">
<div style="width:920px">
    <canvas id="mg" style="height:500px; width:500px;float:left" onMouseMove="showCursor(event)"
            onClick="moveStep(event)">
        You browser does not support canvas.
    </canvas>
    <div style="width:400px; height:500px;float:right">
        <div style="margin-bottom:50px;">
            <input type="button" value="Start playing" onclick="startNewTask();"/>
            <input type="button" value="Restore" onclick="reset();"/>
            <br/>
            <span style="font-style:italic; color:#888888">Will start timer when you first click magic cube! </span>
        </div>
        <div>
            <span id="msg" style="font-size:28px;color:darkGoldenRod;">Not started yet</span> <br/>
            <span id="grade" style="color:red"></span>
        </div>
    </div>
    <div id="log">
    </div>
</div>
</body>
</html>